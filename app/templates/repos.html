{% extends "base_home.html" %}
{% block body_class %}dashboard-page{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/repos.css') }}">
{% endblock %}
{% block content %}

<input type="checkbox" id="sidebar-toggle">

{% if 'user' in session %}
<!-- Sidebar -->
<div class="sidebar">

    <!-- Botón cerrar (mobile only) -->
    <label for="sidebar-toggle" class="close-sidebar">
        <span class="las la-times"></span>
    </label>

    <div class="sidebar-main">
        <div class="sidebar-user">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" />
        </div>

        <div class="sidebar-menu">
            <ul>
                <li>
                    <a href="{{ url_for('main.index') }}">
                        <span class="las las la-home"></span>
                        Inicio
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('usuarios.logout') }}">
                        <span class="las la-sign-out-alt"></span>
                        Cerrar Sesión
                    </a>
                </li>
            </ul>

        </div>
    </div>
</div>
{% endif %}

<!-- Main Content -->
<div class="main-content">

    <header>
        <div class="menu-toggle">
            <label for="sidebar-toggle">
                <span class="las la-bars"></span>
            </label>
        </div>

        <div class="header-icons">
            <div class="search-bar">
                <span class="las la-search"></span>
                <input type="text" placeholder="Buscar..." id="search-input">
            </div>

            <div class="user-info">
                <span class="las la-user"></span>
                <h3>{{ session.get('user')['username'] }}</h3>
            </div>
        </div>

    </header>

    <main>
        <div class="page-header">
            <h1>Mis repositorios</h1>

            <a id="open-modal-btn" class="btn-new-repo">
                + Nuevo repositorio
            </a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, msg in messages %}
        {% if category == 'success' %}
        <div class="flash-message success">{{ msg }}</div>
        {% endif %}
        {% endfor %}
        {% endif %}
        {% endwith %}


        <!-- Cards de repositorios -->
        <div class="cards">
            {% if repos %}
            {% for repo in repos %}

            {% if repo.usuario == session.get('user')['username']
            or session.get('user')['username'] in repo.integrantes%}

            <div class="card-single" data-categoria="{{ repo.categoria }}">
                <div class="card-flex">
                    <div class="card-info">
                        <div class="card-head">
                            <div class="title-row">
                                {% if repo.estado == "aceptado"%}
                                <h2 style="color: green;">{{ repo.nombre }}</h2>
                                <small>Repositorio Aceptado</small>
                                {% elif repo.estado == "rechazado"%}
                                <h2 style="color: red;">{{ repo.nombre }}</h2>
                                <small>Repositorio Rechazado</small>
                                {% else %}
                                <h2 style="color: orange;">{{ repo.nombre }}</h2>
                                <small>Repositorio en revisión</small>
                                {% endif %}
                                <span class="las la-folder"></span>
                            </div>
                            <small>{{ repo.descripcion }}</small>
                        </div>

                        <div class="repo-buttons">
                            <a href="{{ url_for('repos.comandos', nombre=repo.nombre) }}" class="btn">Ver comandos</a>
                            <a href="{{ url_for('repos.explorar_archivos', nombre=repo.nombre) }}" class="btn">Explorar
                                archivos</a>
                            <a href="{{ url_for('repos.informacion_repo', nombre=repo.nombre, repo_id=repo._id) }}"
                                class="btn">Ver Información</a>

                            {% if repo.usuario == session.get('user')['username'] %}
                                <button class="btn delete"
                                    onclick="document.getElementById('del-{{ repo.nombre }}').submit();">
                                    Eliminar
                                </button>
                                <form id=" del-{{ repo.nombre }}" method="POST"
                                    action="{{ url_for('repos.eliminar', nombre=repo.nombre) }}" style="display: none;">
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {% endif %}

            {% endfor %}
            {% else %}
            <p>No tienes repositorios aún.</p>
            {% endif %}
        </div>


        <!-- Modal -->
        <div id="modal-crear-repo" class="modal-overlay" style="display:none;">
            <div class="modal-content">

                <span class="modal-close" id="close-modal-btn">&times;</span>

                <h2 class="form">Crear nuevo repositorio</h2>

                <form method="POST" enctype="multipart/form-data" action="{{ url_for('repos.crear') }}">

                    <!-- Información general del proyecto -->
                    <div>
                        <label>
                            <p>Nombre del proyecto</p>
                            <input type="text" name="nombre" placeholder="Nombre" required>
                        </label>
                    </div>

                    <div>
                        <label>
                            <p>Fecha de creación</p>
                            <input type="date" name="fecha_creacion" required max="{{ current_date }}">
                        </label>
                    </div>

                    <div>
                        <label>
                            <p>Estado del proyecto</p>
                            <select name="estado" required>
                                <option value="Planeación">Planeación</option>
                                <option value="Desarrollo">Desarrollo</option>
                                <option value="Completado">Completado</option>
                                <option value="Pausado">Pausado</option>
                            </select>
                        </label>
                    </div>

                    <div>
                        <label>
                            <p>Categoría</p>
                            <input type="radio" name="categoria" value="Aplicación web" required> Aplicación Web
                            <input type="radio" name="categoria" value="Aplicación móvil"> Aplicación Móvil
                        </label>
                    </div>

                    <!-- Campos específicos para web/móvil -->
                    <div id="web-movil-fields" style="display:none;">
                        <div>
                            <label>
                                <p>Framework(s) utilizado(s)</p>
                                <div class="custom-multiselect" id="frameworks-multiselect">
                                    <input type="text" placeholder="Selecciona frameworks" readonly
                                        id="frameworks-input">
                                    <div class="options">
                                        <label><input type="checkbox" value="React"> React</label>
                                        <label><input type="checkbox" value="Angular"> Angular</label>
                                        <label><input type="checkbox" value="Vue"> Vue</label>
                                        <label><input type="checkbox" value="Django"> Django</label>
                                        <label><input type="checkbox" value="Flask"> Flask</label>
                                        <label><input type="checkbox" value="Laravel"> Laravel</label>
                                        <label><input type="checkbox" value="Spring"> Spring</label>
                                        <label><input type="checkbox" value="Express"> Express</label>
                                        <label><input type="checkbox" value="Flutter"> Flutter</label>
                                    </div>
                                </div>
                                <input type="hidden" name="frameworks[]" id="frameworks-hidden">
                            </label>
                        </div>
                        <div>
                            <label>
                                <p>Lenguaje(s) principal(es)</p>
                                <div class="custom-multiselect" id="lenguajes-multiselect">
                                    <input type="text" placeholder="Selecciona lenguajes" readonly id="lenguajes-input">
                                    <div class="options">
                                        <label><input type="checkbox" value="JavaScript"> JavaScript</label>
                                        <label><input type="checkbox" value="TypeScript"> TypeScript</label>
                                        <label><input type="checkbox" value="Python"> Python</label>
                                        <label><input type="checkbox" value="Java"> Java</label>
                                        <label><input type="checkbox" value="C#"> C#</label>
                                        <label><input type="checkbox" value="PHP"> PHP</label>
                                        <label><input type="checkbox" value="Ruby"> Ruby</label>
                                        <label><input type="checkbox" value="C++"> C++</label>
                                        <label><input type="checkbox" value="Dart"> Dart</label>
                                    </div>
                                </div>
                                <input type="hidden" name="lenguajes[]" id="lenguajes-hidden">
                            </label>
                        </div>
                        <div>
                            <textarea name="descripcion" placeholder="Descripción general del proyecto" rows="4"
                                required></textarea>
                        </div>

                        <div>
                            <label>
                                <p>Plataforma de destino</p>
                                <select name="plataforma">
                                    <option value="Web">Web</option>
                                    <option value="iOS">iOS</option>
                                    <option value="Android">Android</option>
                                    <option value="Multiplataforma">Multiplataforma</option>
                                </select>
                            </label>
                        </div>
                        <div>
                            <label>
                                <p>Versión del proyecto</p>
                                <input type="text" name="version" placeholder="v1.0.0">
                            </label>
                        </div>

                        <!-- Multimedia -->
                        <label class="file-input-label">
                            Seleccionar archivos (imágenes / video)
                            <input type="file" name="multimedia[]" accept="image/*,video/*" multiple
                                id="multimedia-input">
                        </label>
                        <div id="preview" style="margin-top:10px;"></div>

                        <!-- Integrantes -->
                        <div>
                            <p>Integrantes (opcional)</p>
                            <div id="integrantes-list">
                                <button type="button" id="add-integrante">+</button>
                                <button type="button" id="remove-integrante">Quitar</button>
                                <div>
                                    <input type="text" name="integrantes_nombre[]" placeholder="Nombre del integrante"
                                        class="integrante-input" autocomplete="off">
                                    <ul class="sugerencias"></ul>
                                </div>
                            </div>

                            <!-- Información adicional -->
                            <div>
                                <label>
                                    <p>Objetivo principal del proyecto</p>
                                    <textarea name="objetivo" rows="3" placeholder="Objetivo principal"></textarea>
                                </label>
                            </div>
                            <div>
                                <label>
                                    <p>Retos o dificultades enfrentadas</p>
                                    <textarea name="retos" rows="3" placeholder="Describe los retos"></textarea>
                                </label>
                            </div>
                            <div>
                                <label>
                                    <p>Prioridad del proyecto</p>
                                    <select name="prioridad">
                                        <option value="Baja">Baja</option>
                                        <option value="Media">Media</option>
                                        <option value="Alta">Alta</option>
                                    </select>
                                </label>
                            </div>
                            <div>
                                <label>
                                    <p>Comentarios adicionales</p>
                                    <textarea name="comentarios" rows="3"
                                        placeholder="Observaciones generales"></textarea>
                                </label>
                            </div>
                        </div>
                        <button type="submit" onclick="crearRepositorio()">Crear</button>
                </form>
            </div>
        </div>

        <!-- update informacion Modal -->
        
    </main>
</div>

<div id="progreso-modal" class="modal-overlay" style="display:none;
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.6); justify-content:center; align-items:center;">

    <div class="modal-content" style="background:#fff; padding:20px; border-radius:10px;">
        <p id="mensaje-progreso">Iniciando...</p>
    </div>
</div>


<script>
    function mostrarProgreso() {
        const modal = document.getElementById("progreso-modal");
        const msg = document.getElementById("mensaje-progreso");

        modal.style.display = "flex";

        const pasos = [
            "Creando repositorio...",
            "Creando carpeta en Dropbox...",
            "Subiendo archivos multimedia...",
            "Guardando información en la base de datos...",
            "Procesando datos finales..."
        ];

        let i = 0;

        const intervalo = setInterval(() => {
            msg.innerText = pasos[i];
            i++;

            if (i >= pasos.length) {
                clearInterval(intervalo);
            }
        }, 1200);
    }
</script>


<script>
    function crearRepositorio() {
        mostrarProgreso();  // ⬅ popup de mensajes mientras se crea todo

        const form = document.querySelector("#modal-crear-repo form");
        const formData = new FormData(form);

        fetch("{{ url_for('repos.crear') }}", {
            method: "POST",
            body: formData
        })
            .then(res => res.json())
            .then(data => {

                if (data.status === "ok") {
                    // Finaliza popup
                    document.getElementById("mensaje-progreso").innerText = "Repositorio creado correctamente";

                    setTimeout(() => {
                        document.getElementById("modal-crear-repo").style.display = "none";
                        location.reload(); // opcional recargar
                    }, 1500);
                } else {
                    alert("Error: " + data.message);
                }
            })
    }
</script>

<script>
    document.getElementById("open-modal-btn").addEventListener("click", function (e) {
        e.preventDefault();
        document.getElementById("modal-crear-repo").style.display = "flex";
    });

    document.getElementById("close-modal-btn").addEventListener("click", function () {
        document.getElementById("modal-crear-repo").style.display = "none";
    });

    // Cerrar al hacer clic fuera del modal
    window.addEventListener("click", function (e) {
        const modal = document.getElementById("modal-crear-repo");
        if (e.target === modal) {
            modal.style.display = "none";
        }
    });
</script>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById("search-input");
        const cards = document.querySelectorAll(".card-single");

        searchInput.addEventListener("input", function () {
            const filter = searchInput.value.toLowerCase().trim();

            cards.forEach(card => {
                const nombre = card.querySelector(".card-head h2")?.textContent.toLowerCase() || "";
                const descripcion = card.querySelector(".card-head small")?.textContent.toLowerCase() || "";
                const categoria = card.getAttribute("data-categoria")?.toLowerCase() || "";

                const match =
                    nombre.includes(filter) ||
                    descripcion.includes(filter) ||
                    categoria.includes(filter);

                card.style.display = match ? "block" : "none";
            });
        });
    });
</script>


<script>
    document.querySelectorAll('input[name="categoria"]').forEach(function (radio) {
        radio.addEventListener('change', function () {
            var webMovil = document.getElementById('web-movil-fields');
            var otros = document.getElementById('otros-fields');
            if (this.value === 'Aplicación web' || this.value === 'Aplicación móvil') {
                webMovil.style.display = 'block';
                otros.style.display = 'none';
            }
        });
    });
</script>

<script>
    document.getElementById('multimedia-input').addEventListener('change', function (event) {
        const preview = document.getElementById('preview');
        preview.innerHTML = '';
        Array.from(event.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function (e) {
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '150px';
                    img.style.maxHeight = '150px';
                    img.style.margin = '5px';
                    preview.appendChild(img);
                } else if (file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = e.target.result;
                    video.controls = true;
                    video.style.maxWidth = '150px';
                    video.style.maxHeight = '150px';
                    video.style.margin = '5px';
                    preview.appendChild(video);
                }
            };
            reader.readAsDataURL(file);
        });
    });
</script>

<script>
    // Si no usas Jinja para current_date, puedes hacerlo en JS:
    document.addEventListener('DOMContentLoaded', function () {
        var today = new Date().toISOString().split('T')[0];
        document.querySelector('input[name="fecha_creacion"]').setAttribute('max', today);
    });
</script>

<script>
    const multiselect = document.getElementById('frameworks-multiselect');
    const input = document.getElementById('frameworks-input');
    const hiddenInput = document.getElementById('frameworks-hidden');
    const options = multiselect.querySelector('.options');

    input.addEventListener('click', () => {
        options.style.display = options.style.display === 'block' ? 'none' : 'block';
    });

    options.querySelectorAll('input[type=checkbox]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const selected = Array.from(options.querySelectorAll('input:checked')).map(cb => cb.value);
            input.value = selected.join(', ');
            hiddenInput.value = selected.join(',');
        });
    });

    // Cerrar dropdown si se hace click fuera
    document.addEventListener('click', function (e) {
        if (!multiselect.contains(e.target)) {
            options.style.display = 'none';
        }
    });
</script>

<script>
    const lenguajesMultiselect = document.getElementById('lenguajes-multiselect');
    const lenguajesInput = document.getElementById('lenguajes-input');
    const lenguajesHidden = document.getElementById('lenguajes-hidden');
    const lenguajesOptions = lenguajesMultiselect.querySelector('.options');

    lenguajesInput.addEventListener('click', () => {
        lenguajesOptions.style.display = lenguajesOptions.style.display === 'block' ? 'none' : 'block';
    });

    lenguajesOptions.querySelectorAll('input[type=checkbox]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const selected = Array.from(lenguajesOptions.querySelectorAll('input:checked')).map(cb => cb.value);
            lenguajesInput.value = selected.join(', ');
            lenguajesHidden.value = selected.join(',');
        });
    });

    // Cerrar dropdown si se hace click fuera
    document.addEventListener('click', function (e) {
        if (!lenguajesMultiselect.contains(e.target)) {
            lenguajesOptions.style.display = 'none';
        }
    });
</script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
{% endblock %}