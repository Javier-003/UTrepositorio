{% extends "base_home.html" %}
{% block body_class %}dashboard-page{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/repos.css') }}">
{% endblock %}
{% block content %}

<input type="checkbox" id="sidebar-toggle">

{% if 'user' in session %}
<!-- Sidebar -->
<div class="sidebar">

    <!-- Botón cerrar (mobile only) -->
    <label for="sidebar-toggle" class="close-sidebar">
        <span class="las la-times"></span>
    </label>

    <div class="sidebar-main">
        <div class="sidebar-user">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" />
        </div>

        <div class="sidebar-menu">
            <ul>
                <li>
                    <a href="{{ url_for('main.index') }}">
                        <span class="las las la-home"></span>
                        Inicio
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('usuarios.logout') }}">
                        <span class="las la-sign-out-alt"></span>
                        Cerrar Sesión
                    </a>
                </li>
            </ul>

        </div>
    </div>
</div>
{% endif %}

<!-- Main Content -->
<div class="main-content">

    <header>
        <div class="menu-toggle">
            <label for="sidebar-toggle">
                <span class="las la-bars"></span>
            </label>
        </div>

        <div class="header-icons">
            <div class="search-bar">
                <span class="las la-search"></span>
                <input type="text" placeholder="Buscar..." id="search-input">
            </div>

            <div class="user-info">
                <span class="las la-user"></span>
                <h3>{{ session.get('user')['username'] }}</h3>
            </div>
        </div>

    </header>

    <main>
        <div class="page-header">
            <div>
                <h1>Mis repositorios</h1>
            </div>
        </div>

        <!-- Cards de repositorios -->
        <div class="cards">
            {% if repos %}
            {% for repo in repos %}
            <div class="card-single">
                <div class="card-flex">
                    <div class="card-info">
                        <div class="card-head">
                            <h2>{{ repo.nombre }}</h2>
                            <small>#{{ repo.descripcion }}</small>
                        </div>

                        <div class="repo-buttons">
                            <a href="{{ url_for('repos.comandos', nombre=repo.nombre) }}" class="btn">Ver comandos</a>
                            <a href="{{ url_for('repos.explorar_archivos', nombre=repo.nombre) }}" class="btn">Explorar
                                archivos</a>
                            <a href="{{ url_for('repos.informacion_repo', nombre=repo.nombre, repo_id=repo._id) }}"
                                class="btn">Ver Información</a>

                            <!-- Botón de eliminar sin form visible -->
                            <button class="btn delete"
                                onclick="document.getElementById('del-{{ repo.nombre }}').submit();">
                                Eliminar
                            </button>

                            <!-- Formulario oculto -->
                            <form id="del-{{ repo.nombre }}" method="POST"
                                action="{{ url_for('repos.eliminar', nombre=repo.nombre) }}" style="display: none;">
                            </form>
                        </div>

                    </div>


                    <span class="las la-folder"></span>

                </div>
            </div>
            {% endfor %}
            {% else %}
            <p>No tienes repositorios aún.</p>
            {% endif %}
        </div>

        <!-- Formulario para crear nuevo repositorio -->
        <h2 class="form">Crear nuevo repositorio</h2>
        <form method="POST" enctype="multipart/form-data" action="{{ url_for('repos.crear') }}">
            <div>
                <label>
                    <p>Nombre del proyecto</p>
                    <input type="text" name="nombre" placeholder="Nombre" required>
                </label>
            </div>
            <div>
                <label>Fecha de creación</label>
                <input type="date" name="fecha_creacion" required max="{{ current_date }}">
            </div>

            <div>
                <label>
                    <p>Categoria</p>
                    <input type="radio" name="categoria" value="Aplicación web" required> Aplicación Web
                    <input type="radio" name="categoria" value="Aplicación movil"> Aplicación Móvil
                </label>
            </div>

            <div id="web-movil-fields" style="display:none;">
                <div>
                    <input type="text" name="framework" placeholder="Framework utilizado">
                </div>
                <div>
                    <input type="text" name="lenguaje" placeholder="Lenguaje principal">
                </div>
                <div>
                    <input type="text" name="descripcion" placeholder="Descripción general del proyecto">
                </div>
                <label class="file-input-label">
                    Seleccionar archivos
                    <input type="file" name="multimedia[]" accept="image/*,video/*" multiple id="multimedia-input">
                </label>
                <div id="preview" style="margin-top:10px;"></div>

                <div>
                    <p>Integrantes (opcional):</p>
                    <div id="integrantes-list">
                        <input type="text" name="Integrantes[]" placeholder="Nombre del integrante">
                    </div>
                    <button type="button" id="add-integrante">+</button>
                    <button type="button" id="remove-integrante">Quitar</button>
                </div>
            </div>

            <div id="otros-fields" style="display:none;">
                <div>
                    <input type="text" name="objetivo" placeholder="Objetivo del proyecto">
                </div>
            </div>

            <button type="submit">Crear</button>
        </form>
    </main>
</div>


<script>
    document.querySelectorAll('input[name="categoria"]').forEach(function (radio) {
        radio.addEventListener('change', function () {
            var webMovil = document.getElementById('web-movil-fields');
            var otros = document.getElementById('otros-fields');
            if (this.value === 'Aplicación web' || this.value === 'Aplicación movil') {
                webMovil.style.display = 'block';
                otros.style.display = 'none';
            }
        });
    });
</script>

<script>
    document.getElementById('multimedia-input').addEventListener('change', function (event) {
        const preview = document.getElementById('preview');
        preview.innerHTML = '';
        Array.from(event.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function (e) {
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '150px';
                    img.style.maxHeight = '150px';
                    img.style.margin = '5px';
                    preview.appendChild(img);
                } else if (file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = e.target.result;
                    video.controls = true;
                    video.style.maxWidth = '150px';
                    video.style.maxHeight = '150px';
                    video.style.margin = '5px';
                    preview.appendChild(video);
                }
            };
            reader.readAsDataURL(file);
        });
    });
</script>
<script>
    // Si no usas Jinja para current_date, puedes hacerlo en JS:
    document.addEventListener('DOMContentLoaded', function () {
        var today = new Date().toISOString().split('T')[0];
        document.querySelector('input[name="fecha_creacion"]').setAttribute('max', today);
    });
</script>

<script src="{{ url_for('static', filename='js/script.js') }}"></script>
{% endblock %}