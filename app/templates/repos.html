{% extends "base_home.html" %}
{% block body_class %}dashboard-page{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/repos.css') }}">
{% endblock %}
{% block content %}

<input type="checkbox" id="sidebar-toggle">

{% if 'user' in session %}
<!-- Sidebar -->
<div class="sidebar">

    <!-- Botón cerrar (mobile only) -->
    <label for="sidebar-toggle" class="close-sidebar">
        <span class="las la-times"></span>
    </label>

    <div class="sidebar-main">
        <div class="sidebar-user">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" />
        </div>

        <div class="sidebar-menu">
            <ul>
                <li>
                    <a href="{{ url_for('main.index') }}">
                        <span class="las las la-home"></span>
                        Inicio
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('usuarios.logout') }}">
                        <span class="las la-sign-out-alt"></span>
                        Cerrar Sesión
                    </a>
                </li>
            </ul>

        </div>
    </div>
</div>
{% endif %}

<!-- Main Content -->
<div class="main-content">

    <header>
        <div class="menu-toggle">
            <label for="sidebar-toggle">
                <span class="las la-bars"></span>
            </label>
        </div>

        <div class="header-icons">
            <div class="search-bar">
                <span class="las la-search"></span>
                <input type="text" placeholder="Buscar..." id="search-input">
            </div>

            <div class="user-info">
                <span class="las la-user"></span>
                <h3>{{ session.get('user')['username'] }}</h3>
            </div>
        </div>

    </header>

    <main>
        <div class="page-header">
            <div>
                <h1>Mis repositorios</h1>
            </div>
        </div>

        <!-- Cards de repositorios -->
        <div class="cards">
            {% if repos %}
            {% for repo in repos %}
            <div class="card-single">
                <div class="card-flex">
                    <div class="card-info">
                        <div class="card-head">
                            <h2>{{ repo.nombre }}</h2>
                            <small>#{{ repo.descripcion }}</small>
                        </div>

                        <div class="repo-buttons">
                            <a href="{{ url_for('repos.comandos', nombre=repo.nombre) }}" class="btn">Ver comandos</a>
                            <a href="{{ url_for('repos.explorar_archivos', nombre=repo.nombre) }}" class="btn">Explorar
                                archivos</a>
                            <a href="{{ url_for('repos.informacion_repo', nombre=repo.nombre, repo_id=repo._id) }}"
                                class="btn">Ver Información</a>

                            <!-- Botón de eliminar sin form visible -->
                            <button class="btn delete"
                                onclick="document.getElementById('del-{{ repo.nombre }}').submit();">
                                Eliminar
                            </button>
                            <!-- Formulario oculto -->
                            <form id="del-{{ repo.nombre }}" method="POST"
                                action="{{ url_for('repos.eliminar', nombre=repo.nombre) }}" style="display: none;">
                            </form>
                        </div>

                    </div>


                    <span class="las la-folder"></span>

                </div>
            </div>
            {% endfor %}
            {% else %}
            <p>No tienes repositorios aún.</p>
            {% endif %}
        </div>

        <!-- Formulario para crear nuevo repositorio -->
        <h2 class="form">Crear nuevo repositorio</h2>
        <form method="POST" enctype="multipart/form-data" action="{{ url_for('repos.crear') }}">

            <!-- Información general del proyecto -->
            <div>
                <label>
                    <p>Nombre del proyecto</p>
                    <input type="text" name="nombre" placeholder="Nombre" required>
                </label>
            </div>

            <div>
                <label>
                    <p>Fecha de creación</p>
                    <input type="date" name="fecha_creacion" required max="{{ current_date }}">
                </label>
            </div>

            <div>
                <label>
                    <p>Estado del proyecto</p>
                    <select name="estado" required>
                        <option value="Planeación">Planeación</option>
                        <option value="Desarrollo">Desarrollo</option>
                        <option value="Completado">Completado</option>
                        <option value="Pausado">Pausado</option>
                    </select>
                </label>
            </div>

            <div>
                <label>
                    <p>Categoría</p>
                    <input type="radio" name="categoria" value="Aplicación web" required> Aplicación Web
                    <input type="radio" name="categoria" value="Aplicación móvil"> Aplicación Móvil
                </label>
            </div>

            <!-- Campos específicos para web/móvil -->
            <div id="web-movil-fields" style="display:none;">
                <div>
                    <label>
                        <p>Framework(s) utilizado(s)</p>
                        <div class="custom-multiselect" id="frameworks-multiselect">
                            <input type="text" placeholder="Selecciona frameworks" readonly id="frameworks-input">
                            <div class="options">
                                <label><input type="checkbox" value="React"> React</label>
                                <label><input type="checkbox" value="Angular"> Angular</label>
                                <label><input type="checkbox" value="Vue"> Vue</label>
                                <label><input type="checkbox" value="Django"> Django</label>
                                <label><input type="checkbox" value="Flask"> Flask</label>
                                <label><input type="checkbox" value="Laravel"> Laravel</label>
                                <label><input type="checkbox" value="Spring"> Spring</label>
                                <label><input type="checkbox" value="Express"> Express</label>
                                <label><input type="checkbox" value="Flutter"> Flutter</label>
                            </div>
                        </div>
                        <input type="hidden" name="frameworks[]" id="frameworks-hidden">
                    </label>
                </div>
                <div>
                    <label>
                        <p>Lenguaje(s) principal(es)</p>
                        <div class="custom-multiselect" id="lenguajes-multiselect">
                            <input type="text" placeholder="Selecciona lenguajes" readonly id="lenguajes-input">
                            <div class="options">
                                <label><input type="checkbox" value="JavaScript"> JavaScript</label>
                                <label><input type="checkbox" value="TypeScript"> TypeScript</label>
                                <label><input type="checkbox" value="Python"> Python</label>
                                <label><input type="checkbox" value="Java"> Java</label>
                                <label><input type="checkbox" value="C#"> C#</label>
                                <label><input type="checkbox" value="PHP"> PHP</label>
                                <label><input type="checkbox" value="Ruby"> Ruby</label>
                                <label><input type="checkbox" value="C++"> C++</label>
                                <label><input type="checkbox" value="Dart"> Dart</label>
                            </div>
                        </div>
                        <input type="hidden" name="lenguajes[]" id="lenguajes-hidden">
                    </label>
                </div>
                <div>
                    <textarea name="descripcion" placeholder="Descripción general del proyecto" rows="4"
                        required></textarea>
                </div>

                <div>
                    <label>
                        <p>Plataforma de destino</p>
                        <select name="plataforma">
                            <option value="Web">Web</option>
                            <option value="iOS">iOS</option>
                            <option value="Android">Android</option>
                            <option value="Multiplataforma">Multiplataforma</option>
                        </select>
                    </label>
                </div>
                <div>
                    <label>
                        <p>Versión del proyecto</p>
                        <input type="text" name="version" placeholder="v1.0.0">
                    </label>
                </div>

                <!-- Multimedia -->
                <label class="file-input-label">
                    Seleccionar archivos (imágenes / video)
                    <input type="file" name="multimedia[]" accept="image/*,video/*" multiple id="multimedia-input">
                </label>
                <div id="preview" style="margin-top:10px;"></div>

                <!-- Integrantes -->
                <div>
                    <p>Integrantes (opcional)</p>
                    <div id="integrantes-list">
                        <div>
                            <input type="text" name="integrantes_nombre[]" placeholder="Nombre del integrante"class="integrante-input"
                        autocomplete="off">
                    <ul class="sugerencias"></ul>
                    </div>
                    <button type="button" id="add-integrante">+</button>
                    <button type="button" id="remove-integrante">Quitar</button>
                </div>

                <!-- Información adicional -->
                <div>
                    <label>
                        <p>Objetivo principal del proyecto</p>
                        <textarea name="objetivo" rows="3" placeholder="Objetivo principal"></textarea>
                    </label>
                </div>
                <div>
                    <label>
                        <p>Retos o dificultades enfrentadas</p>
                        <textarea name="retos" rows="3" placeholder="Describe los retos"></textarea>
                    </label>
                </div>
                <div>
                    <label>
                        <p>Prioridad del proyecto</p>
                        <select name="prioridad">
                            <option value="Baja">Baja</option>
                            <option value="Media">Media</option>
                            <option value="Alta">Alta</option>
                        </select>
                    </label>
                </div>
                <div>
                    <label>
                        <p>Comentarios adicionales</p>
                        <textarea name="comentarios" rows="3" placeholder="Observaciones generales"></textarea>
                    </label>
                </div>
            </div>

            <button type="submit">Crear</button>
        </form>

    </main>
</div>


<script>
    document.querySelectorAll('input[name="categoria"]').forEach(function (radio) {
        radio.addEventListener('change', function () {
            var webMovil = document.getElementById('web-movil-fields');
            var otros = document.getElementById('otros-fields');
            if (this.value === 'Aplicación web' || this.value === 'Aplicación móvil') {
                webMovil.style.display = 'block';
                otros.style.display = 'none';
            }
        });
    });
</script>

<script>
    document.getElementById('multimedia-input').addEventListener('change', function (event) {
        const preview = document.getElementById('preview');
        preview.innerHTML = '';
        Array.from(event.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function (e) {
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '150px';
                    img.style.maxHeight = '150px';
                    img.style.margin = '5px';
                    preview.appendChild(img);
                } else if (file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = e.target.result;
                    video.controls = true;
                    video.style.maxWidth = '150px';
                    video.style.maxHeight = '150px';
                    video.style.margin = '5px';
                    preview.appendChild(video);
                }
            };
            reader.readAsDataURL(file);
        });
    });
</script>
<script>
    // Si no usas Jinja para current_date, puedes hacerlo en JS:
    document.addEventListener('DOMContentLoaded', function () {
        var today = new Date().toISOString().split('T')[0];
        document.querySelector('input[name="fecha_creacion"]').setAttribute('max', today);
    });
</script>
<script>
    const multiselect = document.getElementById('frameworks-multiselect');
    const input = document.getElementById('frameworks-input');
    const hiddenInput = document.getElementById('frameworks-hidden');
    const options = multiselect.querySelector('.options');

    input.addEventListener('click', () => {
        options.style.display = options.style.display === 'block' ? 'none' : 'block';
    });

    options.querySelectorAll('input[type=checkbox]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const selected = Array.from(options.querySelectorAll('input:checked')).map(cb => cb.value);
            input.value = selected.join(', ');
            hiddenInput.value = selected.join(',');
        });
    });

    // Cerrar dropdown si se hace click fuera
    document.addEventListener('click', function (e) {
        if (!multiselect.contains(e.target)) {
            options.style.display = 'none';
        }
    });
</script>

<script>
    const lenguajesMultiselect = document.getElementById('lenguajes-multiselect');
    const lenguajesInput = document.getElementById('lenguajes-input');
    const lenguajesHidden = document.getElementById('lenguajes-hidden');
    const lenguajesOptions = lenguajesMultiselect.querySelector('.options');

    lenguajesInput.addEventListener('click', () => {
        lenguajesOptions.style.display = lenguajesOptions.style.display === 'block' ? 'none' : 'block';
    });

    lenguajesOptions.querySelectorAll('input[type=checkbox]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const selected = Array.from(lenguajesOptions.querySelectorAll('input:checked')).map(cb => cb.value);
            lenguajesInput.value = selected.join(', ');
            lenguajesHidden.value = selected.join(',');
        });
    });

    // Cerrar dropdown si se hace click fuera
    document.addEventListener('click', function (e) {
        if (!lenguajesMultiselect.contains(e.target)) {
            lenguajesOptions.style.display = 'none';
        }
    });
</script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
{% endblock %}