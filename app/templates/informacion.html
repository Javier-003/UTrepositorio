{% extends "base_home.html" %}
{% block body_class %}information-page{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/informacion.css') }}">
{% endblock %}
{% block content %}


<input type="checkbox" id="sidebar-toggle">

{% if 'user' in session %}
<!-- Sidebar -->
<div class="sidebar">

    <!-- Botón cerrar (mobile only) -->
    <label for="sidebar-toggle" class="close-sidebar">
        <span class="las la-times"></span>
    </label>

    <div class="sidebar-main">

        <div class="sidebar-user">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" />
        </div>

        <!-- Menú para usuarios logueados -->
        <div class="sidebar-menu">
            <ul>
                <li>
                    <a href="{{ url_for('main.index') }}">
                        <span class="las la-home"></span>
                        Volver al inicio
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('repos.repositorios') }}">
                        <span class="las la-folder"></span>
                        Mis repositorios
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('usuarios.logout') }}">
                        <span class="las la-sign-out-alt"></span>
                        Cerrar sesión
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>
{% else %}

<!-- Sidebar para usuarios no logueados -->
<div class="sidebar">

    <!-- Botón cerrar (mobile only) -->
    <label for="sidebar-toggle" class="close-sidebar">
        <span class="las la-times"></span>
    </label>

    <div class="sidebar-main">
        <div class="sidebar-user">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" />
        </div>

        <div class="sidebar-menu">
            <ul>
                <li>
                    <a href="{{ url_for('main.index') }}">
                        <span class="las la-home"></span>
                        Volver al inicio
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('usuarios.login') }}">
                        <span class="las la-sign-in-alt"></span>
                        Iniciar sesión
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>
{% endif %}

<!-- Main Content -->
<div class="main-content">

    <header>
        <div class="menu-toggle">
            <label for="sidebar-toggle">
                <span class="las la-bars"></span>
            </label>
        </div>

        <div class="header-icons">

            <!-- Usuario con nombre -->
            <div class="user-info">
                <span class="las la-user"></span>
                <h3>{{ session.get('user')['username'] }}</h3>
            </div>
        </div>
    </header>

    <main>
        <div class="page-header">
            <div>
                <h1>Información del Repositorio</h1>
            </div>
        </div>

        <div class="cards">
            <div class="card-single repo-info-card">
                <div class="repo-layout">
                    <!-- Información textual -->
                    <div class="repo-details">
                        <h2>{{ repo.nombre }}</h2>
                        <p class="repo-desc">{{ repo.descripcion }}</p>

                        <div class="repo-meta">
                            
                            <p><strong>Categoría:</strong> {{ repo.categoria }}</p>
                            <p><strong>Fecha de creación:</strong> {{ repo.fecha_creacion }}</p>

                            {% if repo.framework %}
                            <p><strong>Framework:</strong> {{ repo.framework }}</p>
                            {% endif %}

                            {% if repo.lenguaje %}
                            <p><strong>Lenguaje:</strong> {{ repo.lenguaje }}</p>
                            {% endif %}
                            {%if repo.razon_rechazo == null%}
                            {% else %}
                            <p style="color: red;"><strong>Razon de rechazo:</strong> {{ repo.razon_rechazo }}</p>
                            {% endif %}
                        </div>

                        <div class="repo-integrantes">
                            <h3>Integrantes</h3>
                            {% if repo.integrantes %}
                            <ul>
                                {% for integrante in repo.integrantes %}
                                <li>{{ integrante }}</li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p>No hay integrantes registrados.</p>
                            {% endif %}
                        </div>
                    </div>


                    <!-- Multimedia -->
                    <div class="carousel-container">
                        <div class="carousel-wrapper">
                            {% for archivo in archivos %}
                            {% set enlace_directo = archivo.webViewLink.replace('dl=0', 'raw=1') %}
                            <div class="carousel-item">
                                {% if archivo.nombre.endswith(('.png', '.jpg', '.jpeg', '.webp', '.gif')) %}
                                <img src="{{ enlace_directo }}" alt="{{ archivo.nombre }}">
                                {% elif archivo.nombre.endswith(('.mp4', '.webm', '.ogg')) %}
                                <video controls>
                                    <source src="{{ enlace_directo }}">
                                </video>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Controles -->
                        <button class="carousel-btn prev">❮</button>
                        <button class="carousel-btn next">❯</button>
                    </div>
                    <a id="open-modal-btn" class="btn-new-repo">
                        Ver mas información
                    </a>
                    {% if repo.usuario == session.get('user')['username'] %}
                    {% if repo.estado == "rechazado"%}
                    <a id="open-modal-update-btn" class="btn-new-repo">
                        Editar Repositorio
                    </a>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>

        <div id="modal-crear-repo" class="modal-overlay" style="display:none;">
            <div class="modal-content repo-modal">

                <span class="modal-close" id="close-modal-btn">&times;</span>

                <h2 class="form-title">Información del Proyecto</h2>

                <div class="repo-info-section">

                    <div class="repo-block">
                        <h3>Datos Generales</h3>
                        <div class="info-grid">
                            <div class="info-item"><strong>Nombre:</strong> {{ repo.nombre }}</div>
                            <div class="info-item"><strong>Fecha de creación:</strong> {{ repo.fecha_creacion }}</div>
                            <div class="info-item">
                                <strong>Estado:</strong>
                                <span class="badge 
                            {% if repo.estado=='aceptado' %} badge-green 
                            {% elif repo.estado=='rechazado' %} badge-red 
                            {% else %} badge-yellow {% endif %}">
                                    {{ repo.estado }}
                                </span>
                            </div>
                            <div class="info-item"><strong>Categoría:</strong> {{ repo.categoria }}</div>
                        </div>
                    </div>

                    <div class="repo-block">
                        <h3>Tecnologías</h3>
                        <div class="info-grid">
                            <div class="info-item"><strong>Framework(s):</strong> {{ repo.framework }}</div>
                            <div class="info-item"><strong>Lenguaje(s):</strong> {{ repo.lenguaje }}</div>
                            <div class="info-item"><strong>Plataforma:</strong> {{ repo.plataforma }}</div>
                            <div class="info-item"><strong>Versión:</strong> {{ repo.version_control }}</div>
                        </div>
                    </div>

                    <div class="repo-block">
                        <h3>Descripción</h3>
                        <p class="info-description">{{ repo.descripcion }}</p>
                    </div>

                    <div class="repo-block">
                        <h3>Integrantes</h3>
                        {% if repo.integrantes %}
                        <ul class="integrantes-list">
                            {% for integrante in repo.integrantes %}
                            <li class="integrante-item">
                                <i class="las la-user"></i> {{ integrante }}
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="no-integrantes">No hay integrantes registrados.</p>
                        {% endif %}
                    </div>

                    <div class="repo-block">
                        <h3>Información Adicional</h3>
                        <div class="info-grid">
                            <div class="info-item"><strong>Objetivo:</strong> {{ repo.objetivos }}</div>
                            <div class="info-item"><strong>Retos:</strong> {{ repo.retos }}</div>
                            <div class="info-item"><strong>Prioridad:</strong> {{ repo.prioridad }}</div>
                            <div class="info-item"><strong>Comentarios:</strong> {{ repo.comentarios }}</div>
                        </div>
                    </div>

                </div>
            </div>
        </div>



    </main>
    <div id="modal-update-repo" class="update-modal-overlay" style="display:none;">
        <div class="update-modal-content">

            <span class="update-modal-close" id="close-modal-update-btn">&times;</span>

            <h2 class="update-form-title">Editar Proyecto</h2>

            <form method="POST" enctype="multipart/form-data" action="{{ url_for('repos.update',repo_id=repo._id) }}" class="update-form">

                <!-- Información general del proyecto -->
                <div class="update-form-group">
                    <label>
                        <p>Nombre del proyecto</p>
                        <input type="text" name="nombre" placeholder="Nombre" value="{{ repo.nombre }}" readonly>
                    </label>
                </div>

                <div class="update-form-group">
                    <label>
                        <p>Fecha de creación</p>
                        <input type="date" name="fecha_creacion" value="{{ repo.fecha_creacion }}" required
                            max="{{ current_date }}">
                    </label>
                </div>

                <div class="update-form-group">
                    <label>
                        <p>Estado del proyecto</p>
                        <select name="estado" required>
                            <option value="Planeación" {% if repo.estado=='Planeación' %}selected{% endif %}>Planeación
                            </option>
                            <option value="Desarrollo" {% if repo.estado=='Desarrollo' %}selected{% endif %}>Desarrollo
                            </option>
                            <option value="Completado" {% if repo.estado=='Completado' %}selected{% endif %}>Completado
                            </option>
                            <option value="Pausado" {% if repo.estado=='Pausado' %}selected{% endif %}>Pausado</option>
                        </select>
                    </label>
                </div>

                <div class="update-form-group">
                    <label>
                        <p>Categoría</p>
                        <input type="radio" name="categoria" value="Aplicación web" {% if
                            repo.categoria=='Aplicación web' %}checked{% endif %}> Aplicación Web
                        <input type="radio" name="categoria" value="Aplicación móvil" {% if
                            repo.categoria=='Aplicación móvil' %}checked{% endif %}> Aplicación Móvil
                    </label>
                </div>

                <!-- Frameworks multiselect -->
                <div class="update-form-group">
                    <label>
                        <p>Framework(s) utilizado(s)</p>
                        <div class="update-multiselect" id="frameworks-multiselect">
                            <input type="text" placeholder="Selecciona frameworks" readonly id="frameworks-input">
                            <div class="options">
                                <label><input type="checkbox" value="React"> React</label>
                                <label><input type="checkbox" value="Angular"> Angular</label>
                                <label><input type="checkbox" value="Vue"> Vue</label>
                                <label><input type="checkbox" value="Django"> Django</label>
                                <label><input type="checkbox" value="Flask"> Flask</label>
                                <label><input type="checkbox" value="Laravel"> Laravel</label>
                                <label><input type="checkbox" value="Spring"> Spring</label>
                                <label><input type="checkbox" value="Express"> Express</label>
                                <label><input type="checkbox" value="Flutter"> Flutter</label>
                            </div>
                        </div>
                        <input type="hidden" name="frameworks[]" id="frameworks-hidden" value="{{ repo.framework }}">
                    </label>
                </div>

                <!-- Lenguajes multiselect -->
                <div class="update-form-group">
                    <label>
                        <p>Lenguaje(s) principal(es)</p>
                        <div class="update-multiselect" id="lenguajes-multiselect">
                            <input type="text" placeholder="Selecciona lenguajes" readonly id="lenguajes-input">
                            <div class="options">
                                <label><input type="checkbox" value="JavaScript"> JavaScript</label>
                                <label><input type="checkbox" value="TypeScript"> TypeScript</label>
                                <label><input type="checkbox" value="Python"> Python</label>
                                <label><input type="checkbox" value="Java"> Java</label>
                                <label><input type="checkbox" value="C#"> C#</label>
                                <label><input type="checkbox" value="PHP"> PHP</label>
                                <label><input type="checkbox" value="Ruby"> Ruby</label>
                                <label><input type="checkbox" value="C++"> C++</label>
                                <label><input type="checkbox" value="Dart"> Dart</label>
                            </div>
                        </div>
                        <input type="hidden" name="lenguajes[]" id="lenguajes-hidden" value="{{ repo.lenguaje }}">
                    </label>
                </div>

                <!-- Descripción general del proyecto -->
                <div class="update-form-group">
                    <label>
                        <p>Descripción general del proyecto</p>
                        <textarea name="descripcion" placeholder="Descripción general del proyecto" rows="4"
                            required>{{ repo.descripcion }}</textarea>
                    </label>
                </div>

                <!-- Plataforma -->
                <div class="update-form-group">
                    <label>
                        <p>Plataforma de destino</p>
                        <select name="plataforma">
                            <option value="Web" {% if repo.plataforma=='Web' %}selected{% endif %}>Web</option>
                            <option value="iOS" {% if repo.plataforma=='iOS' %}selected{% endif %}>iOS</option>
                            <option value="Android" {% if repo.plataforma=='Android' %}selected{% endif %}>Android
                            </option>
                            <option value="Multiplataforma" {% if repo.plataforma=='Multiplataforma' %}selected{% endif
                                %}>Multiplataforma</option>
                        </select>
                    </label>
                </div>

                <!-- Versión -->
                <div class="update-form-group">
                    <label>
                        <p>Versión del proyecto</p>
                        <input type="text" name="version" placeholder="v1.0.0" value="{{ repo.version_control }}">
                    </label>
                </div>

                <!-- Integrantes dinámicos -->
                <div class="update-form-group">
                    <p>Integrantes (opcional)</p>
                    <div id="integrantes-list">
                        <button type="button" id="add-integrante">+</button>
                        <button type="button" id="remove-integrante">Quitar</button>

                        {% for integrante in repo.integrantes %}
                        <div class="integrante-item">
                            <input type="text" name="integrantes_nombre[]" placeholder="Nombre del integrante"
                                class="integrante-input" value="{{ integrante }}" autocomplete="off">
                            <ul class="sugerencias"></ul>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Objetivo -->
                <div class="update-form-group">
                    <label>
                        <p>Objetivo principal del proyecto</p>
                        <textarea name="objetivo" rows="3">{{ repo.objetivos }}</textarea>
                    </label>
                </div>

                <!-- Retos -->
                <div class="update-form-group">
                    <label>
                        <p>Retos o dificultades enfrentadas</p>
                        <textarea name="retos" rows="3">{{ repo.retos }}</textarea>
                    </label>
                </div>

                <!-- Prioridad -->
                <div class="update-form-group">
                    <label>
                        <p>Prioridad del proyecto</p>
                        <select name="prioridad">
                            <option value="Baja" {% if repo.prioridad=='Baja' %}selected{% endif %}>Baja</option>
                            <option value="Media" {% if repo.prioridad=='Media' %}selected{% endif %}>Media</option>
                            <option value="Alta" {% if repo.prioridad=='Alta' %}selected{% endif %}>Alta</option>
                        </select>
                    </label>
                </div>

                <!-- Comentarios -->
                <div class="update-form-group">
                    <label>
                        <p>Comentarios adicionales</p>
                        <textarea name="comentarios" rows="3">{{ repo.comentarios }}</textarea>
                    </label>
                </div>

                <button type="submit" class="update-submit-btn">Actualizar información</button>
            </form>
        </div>
    </div>


</div>



<script>
    document.addEventListener("DOMContentLoaded", () => {
        const wrapper = document.querySelector(".carousel-wrapper");
        const items = document.querySelectorAll(".carousel-item");
        const btnPrev = document.querySelector(".carousel-btn.prev");
        const btnNext = document.querySelector(".carousel-btn.next");

        let index = 0;

        function updateCarousel() {
            wrapper.style.transform = `translateX(-${index * 100}%)`;
        }

        btnNext.addEventListener("click", () => {
            index = (index + 1) % items.length;
            updateCarousel();
        });

        btnPrev.addEventListener("click", () => {
            index = (index - 1 + items.length) % items.length;
            updateCarousel();
        });
    });
</script>

<script>
    document.getElementById("open-modal-btn").addEventListener("click", function (e) {
        e.preventDefault();
        document.getElementById("modal-crear-repo").style.display = "flex";
    });

    document.getElementById("close-modal-btn").addEventListener("click", function () {
        document.getElementById("modal-crear-repo").style.display = "none";
    });

    // Cerrar al hacer clic fuera del modal
    window.addEventListener("click", function (e) {
        const modal = document.getElementById("modal-crear-repo");
        if (e.target === modal) {
            modal.style.display = "none";
        }
    });
</script>

<script>
    document.getElementById("open-modal-update-btn").addEventListener("click", function (e) {
        e.preventDefault();
        document.getElementById("modal-update-repo").style.display = "flex";
    });

    document.getElementById("close-modal-update-btn").addEventListener("click", function () {
        document.getElementById("modal-update-repo").style.display = "none";
    });

    // Cerrar al hacer clic fuera del modal
    window.addEventListener("click", function (e) {
        const modal = document.getElementById("modal-update-repo");
        if (e.target === modal) {
            modal.style.display = "none";
        }
    });
</script>


<script>
    const multiselect = document.getElementById('frameworks-multiselect');
    const input = document.getElementById('frameworks-input');
    const hiddenInput = document.getElementById('frameworks-hidden');
    const options = multiselect.querySelector('.options');

    input.addEventListener('click', () => {
        options.style.display = options.style.display === 'block' ? 'none' : 'block';
    });

    options.querySelectorAll('input[type=checkbox]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const selected = Array.from(options.querySelectorAll('input:checked')).map(cb => cb.value);
            input.value = selected.join(', ');
            hiddenInput.value = selected.join(',');
        });
    });

    // Cerrar dropdown si se hace click fuera
    document.addEventListener('click', function (e) {
        if (!multiselect.contains(e.target)) {
            options.style.display = 'none';
        }
    });
</script>

<script>
    const lenguajesMultiselect = document.getElementById('lenguajes-multiselect');
    const lenguajesInput = document.getElementById('lenguajes-input');
    const lenguajesHidden = document.getElementById('lenguajes-hidden');
    const lenguajesOptions = lenguajesMultiselect.querySelector('.options');

    lenguajesInput.addEventListener('click', () => {
        lenguajesOptions.style.display = lenguajesOptions.style.display === 'block' ? 'none' : 'block';
    });

    lenguajesOptions.querySelectorAll('input[type=checkbox]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const selected = Array.from(lenguajesOptions.querySelectorAll('input:checked')).map(cb => cb.value);
            lenguajesInput.value = selected.join(', ');
            lenguajesHidden.value = selected.join(',');
        });
    });

    // Cerrar dropdown si se hace click fuera
    document.addEventListener('click', function (e) {
        if (!lenguajesMultiselect.contains(e.target)) {
            lenguajesOptions.style.display = 'none';
        }
    });
</script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>

{% endblock %}